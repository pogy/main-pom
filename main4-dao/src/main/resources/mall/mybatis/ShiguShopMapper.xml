<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.opentae.data.mall.interfaces.ShiguShopMapper" >

	<!-- 授权同步信息 -->
	<select id="selectTbAuthSyn" resultType="com.opentae.data.mall.beans.ShiguShop">
		SELECT
			s.*,
			m.fresh_time,
			m.expires_in
		FROM
			shigu_shop s,
			taobao_session_map m
		WHERE
			s.tb_nick = m.nick
		AND s.shop_id = #{shopId}
		ORDER BY m.fresh_time DESC
		limit 1
	</select>

	<!-- 商户列表 -->
	<select id="selectShopListByBo" resultType="com.opentae.data.mall.beans.ShiguShop">
		SELECT
			s.*,
			u.user_name,
			u.user_nick,
			m.market_name,
			m.parent_market_name,
			mp.fresh_time,
			mp.expires_in
		FROM
			shigu_shop s left join  member_user u on s.user_id = u.user_id
			inner join shigu_market m on m.market_id = s.floor_id
			left join taobao_session_map mp on mp.nick = s.tb_nick
		WHERE
			1 = 1
		<if test="website!=null and website!=''">
			AND s.web_site = #{website}
		</if>
		<if test="userName!=null and userName!=''">
			AND u.user_name = #{userName}
		</if>
		<if test="userId!=null">
			AND s.user_id = #{userId}
		</if>
		<if test="marketId!=null">
			AND s.market_id = #{marketId}
		</if>
		<if test="floorId!=null">
			AND s.floor_id = #{floorId}
		</if>
		<if test="shopId!=null">
			AND s.shop_id = #{shopId}
		</if>
		<if test="taobaoUrl!=null and taobaoUrl!=''">
			AND s.taobao_url = #{taobaoUrl}
		</if>
		<if test="tbNick!=null and tbNick!=''">
			AND s.tb_nick = #{tbNick}
		</if>
		<if test="shopNum!=null and shopNum!=''">
			AND s.shop_num = #{shopNum}
		</if>
		ORDER BY s.create_date DESC
		limit #{startRow},#{pageSize}
	</select>

	<!-- 商戶COUNT -->
	<select id="selectShopCountByBo" resultType="int">
		SELECT
			count(s.shop_id)
		FROM
			shigu_shop s left join  member_user u on s.user_id = u.user_id
			inner join shigu_market m on m.market_id = s.floor_id
			left join taobao_session_map mp on mp.nick = s.tb_nick
		WHERE
			1 = 1
		<if test="website!=null and website!=''">
			AND s.web_site = #{website}
		</if>
		<if test="userName!=null and userName!=''">
			AND u.user_name = #{userName}
		</if>
		<if test="userId!=null">
			AND s.user_id = #{userId}
		</if>
		<if test="marketId!=null">
			AND s.market_id = #{marketId}
		</if>
		<if test="floorId!=null">
			AND s.floor_id = #{floorId}
		</if>
		<if test="shopId!=null">
			AND s.shop_id = #{shopId}
		</if>
		<if test="taobaoUrl!=null and taobaoUrl!=''">
			AND s.taobao_url = #{taobaoUrl}
		</if>
		<if test="shopName!=null and shopName!=''">
			AND s.shop_name = #{shopName}
		</if>
		<if test="shopNum!=null and shopNum!=''">
			AND s.shop_num = #{shopNum}
		</if>
	</select>

	<!-- 查询店铺给市场 -->
	<select id="selectShopForMarketList" resultType="com.opentae.data.mall.beans.ShiguShop">
		SELECT
			s.*,l.context as shop_tags_contexts
		FROM
			shigu_shop s
		left join (
		select * from shigu_shop_license l where l.license_type = 5 and l.license_failure = 0
		) l on s.shop_id = l.shop_id
		WHERE
			s.shop_status = 0
		AND s.display_in_market = 1
		AND s.floor_id = #{floorId}
	</select>


	<select id="selectShopNumByIds" resultType="java.lang.String">
		SELECT
			s.shop_num from shigu_shop s
		WHERE
			s.shop_id in
		<foreach collection="shopIdList" item="item" open="("
				 separator="," close=")">
			#{item}
		</foreach>
	</select>

	<!-- 店铺查询 FOR 市场页展示 -->
	<select id="selectShopListByShopIdsForMarketList" resultType="com.opentae.data.mall.beans.ShiguShop">
		SELECT
			s.*,l.context as shop_tags_contexts
		  FROM shigu_shop s
			left join (
			select * from shigu_shop_license l where l.license_type = 5 and l.license_failure = 0
			) l on s.shop_id = l.shop_id
		WHERE
			s.shop_id in
		<foreach collection="shopIdList" item="item" open="("
				 separator="," close=")">
			#{item}
		</foreach>
	</select>

	<!-- 查询重复域名 -->
	<select id="selectDoaminRepeatById" resultType="Long">
		SELECT
			shop_id
		FROM
			shigu_shop
		WHERE
			1 = 1
		<if test="domain != null and domain!=''">
			and lower(domain) = lower(#{domain})
		</if>
		<if test="shopId != null and shopId!=''">
			and shop_id != #{shopId}
		</if>
		<if test="shopNum!=null and shopNum!=''">
			and lower(shop_num) = lower(#{shopNum})
		</if>
	</select>

	<select id="selShopNumAndMarkets" resultType="com.opentae.data.mall.beans.ShopNumAndMarket">
		select a.shop_num as shopNum,a.shop_id as shopId,b.market_name as market from shigu_shop a,shigu_market b
		where a.market_id=b.market_id and a.shop_id in
		<foreach collection="shopIdList" item="item" open="("
				 separator="," close=")">
			#{item}
		</foreach>
	</select>
</mapper>