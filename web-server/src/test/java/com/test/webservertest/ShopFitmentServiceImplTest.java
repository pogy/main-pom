package com.test.webservertest;

import com.opentae.core.mybatis.utils.FieldUtil;
import com.opentae.data.mall.beans.ShiguShop;
import com.opentae.data.mall.examples.ShiguShopExample;
import com.opentae.data.mall.interfaces.ShiguMarketMapper;
import com.opentae.data.mall.interfaces.ShiguShopMapper;
import com.shigu.main4.enums.FitmentModuleType;
import com.shigu.main4.exceptions.ShopFitmentException;
import com.shigu.main4.storeservices.ShopFitmentService;
import com.shigu.main4.vo.fitment.ItemPromoteModule;
import com.shigu.seller.services.ShopDesignService;
import com.shigu.seller.vo.ContainerVO;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;

import java.io.IOException;
import java.util.Arrays;
import java.util.Iterator;

import static org.junit.Assert.*;
/**
 * 类名：ShopFitmentServiceImplTest
 * 类路径：com.test.webservertest.ShopFitmentServiceImplTest
 * 创建者：王浩翔
 * 创建时间：2017-08-21 18:17
 * 项目：main-pom
 * 描述：
 */

/**
 * 测试类{@link com.shigu.main4.storeservices.impl.ShopFitmentServiceImpl}
 */
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration( locations = {"classpath*:/applicationContext.xml"} )
public class ShopFitmentServiceImplTest {

    /**
     * 初始化店铺装修工具
     */
    @Test
    public void InitShopFitment() throws Exception {
        //给定市场
        ShiguShopExample example = new ShiguShopExample();
        example.createCriteria().andMarketIdIn(Arrays.asList(marketIds)).andShopIdNotIn(Arrays.asList(ignoredShopIds)).andShopStatusEqualTo(0).andShopIdGreaterThan(43391l);
        shiguShopMapper.selectFieldsByExample(example,FieldUtil.codeFields("shop_id")).stream().map(ShiguShop::getShopId)
                .forEach(o->{
                    try {
                        shopFitmentService.initShopFitment(o);
                        System.out.println(o);
                    } catch (ShopFitmentException e) {
                        e.printStackTrace();
                    }
                });
        //其他市场
        example = new ShiguShopExample();
        example.createCriteria().andMarketIdNotIn(Arrays.asList(marketIds)).andShopIdNotIn(Arrays.asList(ignoredShopIds)).andShopStatusEqualTo(0).andShopIdGreaterThan(43391l);
        shiguShopMapper.selectByExample(example).stream().forEach(o->{
            try {
                System.out.println(o.getShopId());
                if (noFitment(shopDesignService.selPagePublishedById(shopDesignService.selPageIdByShopId(o.getShopId()),shopDesignService.selShopForModule(o.getShopId(),
                        o.getWebSite())))) {
                    shopFitmentService.initShopFitment(o.getShopId());
                }
            } catch (IOException e) {
                e.printStackTrace();
            } catch (ShopFitmentException e) {
                e.printStackTrace();
            } catch (NullPointerException e) {
                try {
                    shopFitmentService.initShopFitment(o.getShopId());
                } catch (ShopFitmentException e1) {
                    e1.printStackTrace();
                }
            }
        });
        Runtime.getRuntime().exec("cmd shutdown -s -t 0");
    }

    /**
     * 要进行装修初始化的市场
     */
    Long[] marketIds = {1087L,617L,621L};

    /**
     * 不进行装修初始化的档口id
     */
    Long[] ignoredShopIds = {
            29675l,
            42518l,
            39138l,
            40570l,
            43164l,
            29703l,
            43181l,
            40606l,
            40420l,
            40901l,
            40923l,
            40903l,
            39139l,
            40830l,
            42531l,
            40904l,
            40574l,
            40425l,
            40979l,
            40922l,
            40933l,
            41049l,
            41197l,
            35662l,
            41249l,
            43320l,
            41262l,
            41216l,
            40996l,
            40995l,
            42621l,
            40997l,
            41060l,
            41050l,
            43322l,
            40959l,
            40235l,
            39890l,
            41557l,
            35444l,
            42449l,
            41516l,
            39994l,
            40309l,
            42523l,
            40606l,
            40256l,
            40225l,
            40999l,
            40174l,
            40379l,
            41609l,
            40204l,
            40426l,
            41551l,
            35922l,
            41623l,
            36014l,
            42683l,
            35923l,
            40594l,
            31806l,
            40388l,
            30201l,
            40036l,
            35540l,
            42694l,
            39479l,
            41683l,
            43119l,
            40029l,
            29663l,
            43139l,
            41637l,
            43013l,
            41353l,
            36128l,
            41505l,
            43339l,
            41598l,
            39360l,
            39240l,
            41195l,
            42472l,
            32087l,
            16586l,
            40448l,
            42585l,
            40074l,
            18761l,
            41009l,
            39576l,
            29500l,
            41836l,
            40381l,
            41378l,
            35567l,
            35611l,
            18629l,
            31899l,
            39923l,
            41279l,
            39347l,
            29495l,
            40817l,
            39422l,
            36385l,
            29276l,
            42508l,
            35680l,
            29479l,
            34875l,
            41375l,
            42545l,
            43268l,
            42601l,
            35748l,
            36296l,
            41277l,
            35668l,
            42494l,
            42507l,
            35349l,
            35348l,
            39356l,
            29868l,
            29647l,
            29911l,
            41700l,
            40638l,
            41646l,
            39495l,
            35866l,
            42511l,
            43315l,
            39081l,
            42469l,
            39959l,
            41787l,
            42505l,
            41541l,
            29701l,
            35477l,
            31757l,
            29710l,
            39078l,
            43311l,
            40528l,
            29737l,
            35307l,
            36141l,
            29851l,
            35952l,
            30172l,
            36289l,
            40068l,
            29302l,
            32279l,
            29351l,
            43186l,
            35352l,
            39358l,
            35698l,
            42680l,
            29420l,
            29507l,
            41601l,
            29900l,
            39694l,
            29867l,
            29771l,
            35026l,
            30239l,
            30145l,
            29727l,
            35366l,
            29674l,
            29853l,
            42716l,
            29913l,
            29683l,
            35356l,
            41265l,
            39997l,
            40773l,
            43364l,
            43193l,
            16832l,
            42774l,
            16263l,
            40948l,
            41030l,
            27603l,
            39518l,
            29825l,
            39504l,
            40633l,
            36143l,
            31762l,
            35832l,
            40508l,
            41437l,
            29345l,
            40238l,
            40237l,
            41595l,
            30220l,
            40945l,
            29582l,
            43025l,
            40522l,
            35654l,
            42535l,
            41876l,
            43297l,
            41307l,
            31775l,
            29733l,
            43115l,
            39886l,
            39887l,
            35677l,
            18667l,
            40095l,
            41371l,
            40213l,
            39986l,
            41906l,
            29530l,
            31927l,
            41388l,
            29648l,
            39958l,
            41395l,
            43293l,
            35778l,
            41665l,
            40116l,
            29760l,
            29354l,
            35435l,
            42661l,
            41393l,
            43291l,
            41877l,
            42524l,
            40598l,
            35874l,
            40314l,
            42695l,
            39905l,
            29430l,
            16556l,
            40672l,
            43191l,
            29817l,
            42549l,
            40264l,
            41565l,
            34973l,
            40476l,
            39806l,
            29844l,
            29723l,
            40431l,
            43286l,
            29480l,
            29915l,
            29324l,
            42530l,
            40507l,
            42637l,
            43300l,
            40780l,
            41379l,
            16911l,
            41059l,
            41832l,
            42685l,
            41651l,
            41257l,
            41251l,
            40789l,
            41592l,
            41218l,
            16855l,
            36396l,
            35747l,
            41613l,
            41046l,
            40514l,
            29679l,
            29667l,
            42454l,
            35972l,
            43151l,
            39474l,
            42592l,
            35971l,
            29535l,
            42514l,
            43299l,
            40398l,
            15884l,
            34885l,
            39529l,
            39480l,
            29772l,
            40437l,
            29858l,
            41509l,
            41057l,
            42451l,
            35336l,
            18081l,
            41888l,
            32293l,
            39945l,
            39899l,
            39505l,
            42493l,
            31951l,
            41293l,
            43292l,
            41286l,
            15757l,
            29934l,
            39907l,
            42471l,
            29547l,
            35271l,
            42533l,
            39704l,
            40764l,
            35914l,
            39573l,
            29926l,
            40513l,
            42547l,
            43303l,
            36089l,
            39685l,
            29640l,
            43274l,
            40212l,
            40401l,
            38993l,
            39056l,
            39015l,
            41364l,
            39782l,
            41363l,
            39403l,
            41350l,
            39425l,
            42996l,
            40249l,
            41674l,
            39388l,
            40545l,
            39187l,
            43188l,
            41735l,
            41192l,
            41872l,
            42407l,
            39462l,
            41370l,
            36376l,
            36356l,
            39055l,
            39441l,
            36264l,
            29319l,
            41582l,
            41583l,
            41297l,
            36292l,
            36087l,
            42979l,
            31851l,
            43167l,
            43168l,
            40220l,
            41600l,
            41649l,
            41359l,
            15850l,
            35984l,
            31751l,
            41845l,
            42415l,
            41847l,
            41588l,
            35969l,
            40993l,
            41517l,
            42562l,
            35276l,
            43336l,
            32082l,
            36177l,
            35714l,
            35897l,
            35756l,
            39831l,
            35782l,
            41880l,
            41780l,
            29424l,
            35642l,
            41607l,
            40927l,
            40117l,
            35720l,
            42510l,
            35389l,
            43346l,
            39861l,
            39766l,
            41605l,
            39643l,
            35645l,
            43125l,
            18621l,
            41881l,
            36039l,
            40491l,
            36229l,
            42718l,
            35462l,
            42470l,
            40648l,
            43327l,
            41232l,
            43173l,
            40569l,
            40635l,
            39528l,
            40281l,
            43275l,
            43294l,
            40649l,
            32877l,
            39723l,
            42561l,
            40969l,
            41534l,
            43135l,
            39852l,
            39720l,
            39530l,
            43153l,
            42413l,
            40833l,
            41596l,
            42409l,
            42554l,
            42411l,
            41603l,
            35784l,
            35821l,
            40271l,
            39834l,
            40250l,
            18208l,
            29841l,
            30232l,
            32861l,
            40199l,
            41328l,
            39352l,
            18298l,
            31853l,
            39486l,
            39492l,
            42605l,
            40729l,
            40532l,
            41654l,
            35008l,
            43090l,
            41292l,
            29264l,
            41801l,
            39509l,
            41558l,
            40913l,
            30066l,
            35071l,
            30151l,
            39249l,
            29465l,
            29256l,
            43284l,
            40445l,
            40344l,
            29685l,
            29607l,
            40983l,
            40330l,
            41662l,
            41230l,
            43124l,
            43131l,
            40394l,
            43117l,
            34928l,
            41390l,
            41729l,
            42706l,
            40577l,
            40305l,
            17070l,
            43143l,
            43118l,
            40072l,
            41427l,
            16346l,
            40551l,
            41634l,
            34992l,
            40372l,
            40654l,
            18877l,
            40655l,
            39802l,
            40787l,
            43134l,
            41658l,
            18959l,
            40303l,
            41730l,
            35649l,
            29426l,
            43370l,
            40091l,
            18890l,
            39484l,
            40259l,
            43328l,
            43325l,
            40404l,
            40722l,
            32090l,
            39800l,
            40233l,
            24833l,
            35281l,
            41773l,
            42575l,
            15747l,
            41776l,
            15750l,
            39866l,
            41597l,
            41673l,
            39404l,
            34927l,
            41784l,
            39461l,
            42634l,
            43179l,
            42635l,
            40270l,
            42424l,
            41855l,
            40848l,
            32910l,
            41403l,
            40407l,
            43272l,
            42638l,
            39858l,
            42613l,
            43269l,
            41562l,
            42509l,
            40838l,
            29995l,
            43057l,
            42500l,
            41556l,
            42612l,
            42579l,
            42722l,
            42785l,
            42720l,
            41005l,
            39857l,
            43371l,
            41849l,
            41863l,
            42641l,
            40940l,
            42998l,
            41878l,
            42416l,
            16684l,
            39381l,
            39840l,
            39904l,
            43332l,
            15908l,
            43128l,
            41438l,
            40718l,
            42630l,
            42466l,
            16459l,
            31931l,
            40191l,
            40723l,
            34993l,
            40311l,
            41676l,
            41486l,
            39978l,
            43097l,
            39821l,
            41840l,
            39315l,
            39326l,
            40743l,
            42788l,
            41839l,
            16940l,
            43377l,
            32116l,
            42624l,
            35487l,
            35167l,
            35651l,
            40189l,
            39995l,
            16694l,
            15748l,
            40739l,
            35577l,
            40193l,
            31907l,
            40735l,
            42574l
    };

    @Autowired
    private ShiguShopMapper shiguShopMapper;
    @Autowired
    private ShopFitmentService shopFitmentService;


    @Autowired
    private ShopDesignService shopDesignService;

    //原noFitment逻辑
    private boolean noFitment(ContainerVO vo){
        if(vo.getFitmentAreas()==null||vo.getFitmentAreas().size()!=1
                ||vo.getFitmentAreas().get(0).getLeftarea()==null||vo.getFitmentAreas().get(0).getLeftarea().size()!=1
                ||vo.getFitmentAreas().get(0).getLeftarea().get(0).getModuleType()!= FitmentModuleType.Category.value
                ||vo.getFitmentAreas().get(0).getRightarea()==null||vo.getFitmentAreas().get(0).getRightarea().size()!=1
                ||vo.getFitmentAreas().get(0).getRightarea().get(0).getModuleType()!=FitmentModuleType.Promote.value){
            return false;
        }
        ItemPromoteModule promote= (ItemPromoteModule) vo.getFitmentAreas().get(0).getRightarea().get(0);
        if(promote.getPromoteType()==1&&promote.getSort()==1&&promote.getItemNum()==16&&promote.getShowPage()==0
                &&promote.getShowTitle()==1&&promote.getShowGoodsNo()==0&&promote.getShowPrice()==1
                &&promote.getTitle().equals("推荐宝贝")&&promote.getRadio()==4&&promote.getFilter()==0){
            return true;
        }else{
            return false;
        }
    }
}